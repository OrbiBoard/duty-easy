<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>组别分工</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <link rel="stylesheet" href="../../../renderer/settings.css" />
      <style>
        :root { --panel: rgba(255,255,255,0.06); }
        html, body { height: 100%; }
        body { margin: 0; overflow: auto; }
        .section { padding: 16px; background: transparent !important; border: none !important; }
        .table-wrap { border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; table-layout: fixed; }
      th, td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 8px; }
      th { text-align: left; color: var(--muted); font-weight: 600; position: sticky; top: 0; background: #0b1520; }
      .cell { min-height: 40px; border-radius: 8px; padding: 6px; }
      .tag { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); margin: 4px; }
      .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--fg); cursor: pointer; }
      .btn.secondary { background: rgba(255,255,255,0.08); }
      .btn.danger { background: rgba(255, 100, 100, 0.2); border-color: rgba(255, 100, 100, 0.4); }
      .actions { display:flex; gap:8px; margin-bottom:8px; }
      .hint { color: rgba(255,100,100,0.9); font-size: 12px; margin-top: 6px; }
        .badge { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); font-size:12px; }
        .group-name { cursor: pointer; }
        .group-name.active { font-weight: 700; color: #48cfad; }
        .chip { display:inline-flex; align-items:center; gap:6px; padding:2px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); margin:4px; cursor:pointer }
        .chip.active { border-color: rgba(138,180,248,0.7); background: rgba(138,180,248,0.15); box-shadow: 0 0 0 2px rgba(138,180,248,0.25) inset }
      </style>
  </head>
  <body>
    <div class="section">
      <div class="section-title"><i class="ri-team-line"></i> 组别分工表 </div>
      <div class="actions">
        <button id="openRoles" class="btn secondary"><i class="ri-list-check"></i> 分工列表</button>
        <button id="openGroups" class="btn secondary"><i class="ri-group-line"></i> 分组列表</button>
        <button id="openRules" class="btn secondary"><i class="ri-settings-3-line"></i> 分工规则</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
    <script>
      let channel=''; let caller=''; const studentsChannel='profiles.students.channel'; let currentPick=null; let cfg={ roles:[], groups:[], dynamicRoles:[], rule:{} };
      function el(t,c){const e=document.createElement(t); if(c)e.className=c; return e}
      async function load(){
        try {
          if (window.lowbarAPI?.pluginCall) {
            const res=await window.lowbarAPI.pluginCall(caller,'getConfig'); const r=res?.result||res; cfg=r?.config||{};
          } else if (window.lowbarAPI?.configEnsureDefaults) {
            await window.lowbarAPI.configEnsureDefaults('duty.easy',{
              roles: ['清洁','黑板','值日生'],
              groups: [
                { name: '一组', roles: { '清洁': [], '黑板': [], '值日生': [] } },
                { name: '二组', roles: { '清洁': [], '黑板': [], '值日生': [] } }
              ]
            });
            const all=await window.lowbarAPI.configGetAll('duty.easy'); cfg=all||{};
          } else if (window.pluginAPI?.configEnsureDefaults) {
            await window.pluginAPI.configEnsureDefaults('duty.easy',{});
            const all=await window.pluginAPI.configGetAll('duty.easy'); cfg=all||{};
          }
        } catch {}
        if(!Array.isArray(cfg.roles)) cfg.roles=[]; if(!Array.isArray(cfg.groups)) cfg.groups=[]; if(!Array.isArray(cfg.dynamicRoles)) cfg.dynamicRoles=[]; if(typeof cfg.rule!=='object'||!cfg.rule) cfg.rule={}; render()
      }
      function getDynActive(gi, role){ try{ const d=cfg.rule?.dynamicActiveRole||{}; const giKey=String(gi); const per=d[giKey]||{}; const v=String(per[role]||''); return v }catch{ return '' } }
      async function setDynActive(gi, role, roleName){ try{ const res= await window.lowbarAPI?.pluginCall?.(caller,'getConfig'); const r=res?.result||res; const cur=r?.config||{}; const rule=cur.rule||{}; const dyn= typeof rule.dynamicActiveRole==='object'&&rule.dynamicActiveRole?{...rule.dynamicActiveRole}:{ }; const giKey=String(gi); const per= typeof dyn[giKey]==='object'&&dyn[giKey]?{...dyn[giKey]}:{}; per[role]=roleName; dyn[giKey]=per; await window.lowbarAPI?.pluginCall?.(caller,'saveConfig',[{ rule: { ...rule, dynamicActiveRole: dyn } }]); const verify=await window.lowbarAPI?.pluginCall?.(caller,'getConfig'); const rr=verify?.result||verify; cfg=rr?.config||cfg; try{ if(channel) window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{} render() }catch{} }
      function render(){ const thead=document.getElementById('thead'); const tbody=document.getElementById('tbody'); thead.innerHTML=''; tbody.innerHTML=''; const trh=el('tr'); const th0=el('th'); const curIdx=Number.isFinite(cfg.rule?.currentGroupIndex)?cfg.rule.currentGroupIndex:0; const curName=(cfg.groups||[])[curIdx]?.name||''; th0.innerHTML=`组别 ${curName?`<span class="badge">当前：${curName}</span>`:''}`; trh.appendChild(th0); (cfg.roles||[]).forEach(r=>{ const th=el('th'); th.textContent=r||''; trh.appendChild(th) }); thead.appendChild(trh);
        (cfg.groups||[]).forEach((g,gi)=>{ const tr=el('tr'); const tdGroup=el('td'); tdGroup.textContent=g.name||''; tr.appendChild(tdGroup);
          tdGroup.className='group-name'+(gi===curIdx?' active':''); tdGroup.addEventListener('click',()=>{ setActiveGroup(gi) });
          (cfg.roles||[]).forEach(r=>{ const td=el('td'); const cell=el('div','cell'); const arr=Array.isArray(g.roles?.[r])?g.roles[r]:[]; const isDyn=Array.isArray(cfg.dynamicRoles)?cfg.dynamicRoles.includes(r):false;
            if(isDyn){ const activeName=getDynActive(gi,r); const options=(cfg.roles||[]).filter(roleName=>roleName!=='新分工' && !(Array.isArray(cfg.dynamicRoles)&&cfg.dynamicRoles.includes(roleName))); if(options.length===0){ const empty=el('span','badge'); empty.textContent='无可选择分工'; cell.appendChild(empty) } else { options.forEach(roleName=>{ const chip=el('span','chip'); chip.textContent=roleName||''; if(String(roleName||'')===String(activeName||'')) chip.classList.add('active'); chip.addEventListener('click',()=>{ setDynActive(gi,r,roleName) }); cell.appendChild(chip) }) } const badge=el('span','badge'); badge.innerHTML='<i class="ri-repeat-2-line"></i> 已启用动态分工'; cell.appendChild(badge); }
            else { arr.forEach((n,ni)=>{ const t=el('span','tag'); t.textContent=n||''; const rm=document.createElement('button'); rm.className='btn danger'; rm.innerHTML='<i class="ri-close-line"></i>'; rm.addEventListener('click',(e)=>{ e.stopPropagation(); const a=Array.isArray(cfg.groups?.[gi]?.roles?.[r])?cfg.groups[gi].roles[r]:[]; a.splice(ni,1); render() }); t.appendChild(rm); cell.appendChild(t) }); const addBtn=el('button','btn secondary'); addBtn.innerHTML='<i class="ri-add-line"></i> 添加'; addBtn.addEventListener('click',()=>{ if(hasDupRoles()){ showDupHint(); return } currentPick={gi,r}; openStudentsPicker(); }); cell.appendChild(addBtn); }
            td.appendChild(cell); tr.appendChild(td)
          }); tbody.appendChild(tr)
        })
      }
      function hasDupRoles(){ const names=(cfg.roles||[]).map(s=>String(s||'').trim()).filter(Boolean); return names.some((n,idx)=>names.indexOf(n)!==idx) }
      function showDupHint(){ let hint=document.getElementById('grid-dup-hint'); if(!hint){ hint=document.createElement('div'); hint.id='grid-dup-hint'; hint.className='hint'; hint.textContent='存在重复分工名称，请在“分工列表”修改为唯一后再添加'; document.querySelector('.section').appendChild(hint) }
      }
      function openStudentsPicker(){ try{ const url=new URL('../../../plugins/profiles-students/index.html', window.location.href); url.searchParams.set('channel', studentsChannel); url.searchParams.set('caller','profiles.students'); url.searchParams.set('mode','pick'); window.lowbarAPI?.emitEvent?.(channel, { type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function safeParse(t){ try{ return JSON.parse(String(t||'')) }catch{ return null } }
      function openRolesList(){ try{ const url=new URL('./roles-list.html', window.location.href); url.searchParams.set('channel', channel); url.searchParams.set('caller','duty.easy'); window.lowbarAPI?.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function openGroupsList(){ try{ const url=new URL('./groups-list.html', window.location.href); url.searchParams.set('channel', channel); url.searchParams.set('caller','duty.easy'); window.lowbarAPI?.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      function openRules(){ try{ const url=new URL('./rules.html', window.location.href); url.searchParams.set('channel', channel); url.searchParams.set('caller','duty.easy'); window.lowbarAPI?.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value: url.href }); }catch{} }
      async function save(){ try {
        if (window.lowbarAPI?.pluginCall) {
          await window.lowbarAPI.pluginCall(caller,'saveConfig',[{ groups: cfg.groups }]);
          const res=await window.lowbarAPI.pluginCall(caller,'getConfig'); const r=res?.result||res; cfg=r?.config||cfg;
        } else if (window.lowbarAPI?.configEnsureDefaults) {
          await window.lowbarAPI.configEnsureDefaults('duty.easy',{
            roles: ['清洁','黑板','值日生'],
            groups: [
              { name: '一组', roles: { '清洁': [], '黑板': [], '值日生': [] } },
              { name: '二组', roles: { '清洁': [], '黑板': [], '值日生': [] } }
            ]
          });
          await window.lowbarAPI.configSet('duty.easy','groups',cfg.groups);
          const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        } else if (window.pluginAPI?.configEnsureDefaults) {
          await window.pluginAPI.configEnsureDefaults('duty.easy',{});
          await window.pluginAPI.configSet('duty.easy','groups',cfg.groups);
          const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        }
      } catch {} }
      async function setActiveGroup(gi){ try{
        const nextRule = { ...(cfg.rule||{}), currentGroupIndex: gi };
        if (window.lowbarAPI?.pluginCall) {
          await window.lowbarAPI.pluginCall(caller,'saveConfig',[{ rule: nextRule }]);
          const res=await window.lowbarAPI.pluginCall(caller,'getConfig'); const r=res?.result||res; cfg=r?.config||cfg;
        } else if (window.lowbarAPI?.configEnsureDefaults) {
          await window.lowbarAPI.configEnsureDefaults('duty.easy',{});
          await window.lowbarAPI.configSet('duty.easy','rule', nextRule);
          const verify=await window.lowbarAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        } else if (window.pluginAPI?.configEnsureDefaults) {
          await window.pluginAPI.configEnsureDefaults('duty.easy',{});
          await window.pluginAPI.configSet('duty.easy','rule', nextRule);
          const verify=await window.pluginAPI.configGetAll('duty.easy'); cfg=verify||cfg;
        }
        try{ if(channel) window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'refresh', value:true }) }catch{}
        render()
      }catch{} }
      (function(){ try{const u=new URL(window.location.href); channel=String(u.searchParams.get('channel')||''); caller=String(u.searchParams.get('caller')||'')}catch{}
        if(window.lowbarAPI){ if(channel) window.lowbarAPI.subscribe?.(channel); window.lowbarAPI.subscribe?.(studentsChannel); window.lowbarAPI.onEvent?.(async (n,p)=>{ if(p?.type==='update'){ if(n===channel && p.target==='duty.save'){ await save(); await load() } if(n===channel && p.target==='refresh'){ await load() } } if(n===studentsChannel){ const name=String(p?.name||'').trim(); if(p?.type==='pick' && name && currentPick){ if(hasDupRoles()){ currentPick=null; showDupHint(); return } const arr=Array.isArray(cfg.groups?.[currentPick.gi]?.roles?.[currentPick.r])?cfg.groups[currentPick.gi].roles[currentPick.r]:(cfg.groups[currentPick.gi].roles[currentPick.r]=[]); arr.push(name); currentPick=null; render(); try{ window.lowbarAPI.emitEvent?.(channel,{ type:'update', target:'floatingUrl', value:null }); }catch{} } } }); }
        load(); document.getElementById('openRoles').addEventListener('click',openRolesList); document.getElementById('openGroups').addEventListener('click',openGroupsList); document.getElementById('openRules').addEventListener('click',openRules)
      })();
    </script>
  </body>
  </html>
